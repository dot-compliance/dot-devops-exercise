pipeline {
    agent any
    parameters {
        string(name: 'MEMBER_PACKAGE', defaultValue: 'HelloWorld', description: 'Package to put in xml file')
        string(name: 'TARGET_DIR',     defaultValue: 'c:\\downloads\\dot_deploy', description: 'Where to deploy to (for local deploy only)')
        string(name: 'SF_ORG_ALIAS',   defaultValue: '', description: 'SF org to deploy to (for SF deploy only)')
        booleanParam(name: 'FORCE_DEPLOY',  defaultValue: false, description: 'Set to force SF deploy')
        booleanParam(name: 'DRY_RUN',  defaultValue: false, description: 'Set to only print operations')
    }

    stages {
        stage('Inits') {
            steps {
                script {
                    xmlFile = "$WORKSPACE\\manifest\\package.xml"
                    branchName = "deploy_${params.MEMBER_PACKAGE}"
                }
            }
        }
        stage('Set XML') {
            steps {
                script {
                    pythonLog = 'python.log'
                    gitLog = 'git.log'
                    String xmlNamePlaceHolder = 'PLACE_HOLDER'
                    String pythonScript = "$WORKSPACE\\python\\sedXml.py"
                    echo "Setting XML $xmlFile $xmlNamePlaceHolder to $params.MEMBER_PACKAGE"
                    bat """
                        git checkout -b $branchName > $gitLog || exit
                        echo "Output of python script: $pythonScript" > $pythonLog
                        python $pythonScript --new_string '${params.MEMBER_PACKAGE}.cls' >> $pythonLog || exit
                        echo "========= xml file after sed ============="
                        type $xmlFile
                        echo "============"
                        git commit $xmlFile -m "deploy: ${params.MEMBER_PACKAGE}" >> $gitLog || exit
                        git push origin $branchName  >> $gitLog || exit
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: gitLog
                    archiveArtifacts artifacts: pythonLog
                }
            }
        }

        stage('Local Deploy') {
            steps {
                script {
                    copyLog = 'local_deploy.log'
                    bat """
                        echo 'Local Deploy to $params.TARGET_DIR'
                        mkdir -p $params.TARGET_DIR
                        xcopy $WORKSPACE/config $params.TARGET_DIR /s /e /k > $copyLog  || exit
                        xcopy $WORKSPACE/force-app $params.TARGET_DIR /s /e /k >> $copyLog  || exit
                        xcopy $WORKSPACE/manifest $params.TARGET_DIR /s /e /k >> $copyLog  || exit
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: copyLog
                }
            }
        }

        stage('SF Deploy') {
            steps {
                script {
                    String forceFlag = ''
                    if (params.FORCE_DEPLOY) {
                        forceFlag = ' --force'
                    }
                    sfDeplpoyLog = 'SF_deploy.log'
                    bat """
                        sf deploy functions --connected-org $params.SF_ORG_ALIAS $forceFlag --branch $branchName --json > $sfDeplpoyLog  || exit
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: sfDeplpoyLog
                }
            }
        }

    }
}